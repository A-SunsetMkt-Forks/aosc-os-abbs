#!/usr/bin/bash

# Strip all kernel modules and vdso.so but save a copy in SYMDIR
# Note: This script is standalone - Had to source autobuild4 again to use builtins

# Uses following environment variables:
# - SRCDIR
# - AB
# - DBG_KERNEL_IMAGE="$SYMDIR/usr/lib/debug/boot/vmlinux-$version$LOCALNAME"
# - DBG_MODULES_DIR="$SYMDIR/usr/lib/debug/usr/lib/modules/${version}${LOCALNAME}"
# and following ab4 built-ins
# abelf_copy_dbg

strip_kernel_images() {
	# $1 = destination directory - need to be absolute
	# $2 = file to strip. should be relative to $CWD
	DEST="$1"
	FILE="$2"

	enable -f "$AB/libautobuild.so" autobuild
	install -Dvm644 \
		"$FILE" \
		"${DEST}/${FILE}"
	abelf_copy_dbg -x "$FILE" "${DEST}/$(dirname $FILE)"
}

strip_so() {
	# $1 = file to strip. should be relative to $CWD
	FILE="$1"
	enable -f "$AB/libautobuild.so" autobuild
	echo "Working on $FILE"
	abelf_copy_dbg "$FILE" "${SYMDIR}/usr/lib/debug"
}

export -f strip_kernel_images
export -f strip_so

(
	cd "$SRCDIR";
	find -name '*.ko' | parallel -j $(nproc) strip_kernel_images "$DBG_MODULES_DIR"
	find -name '*.so' | parallel -j $(nproc) strip_so
	(strip_kernel_images $(dirname "$DBG_KERNEL_IMAGE") vmlinux)
	mv -v $(dirname "$DBG_KERNEL_IMAGE")"/vmlinux" "$DBG_KERNEL_IMAGE"
)
