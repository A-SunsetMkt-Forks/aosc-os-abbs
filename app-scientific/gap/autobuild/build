# Adapted from Arch Linux.

#prepare
# Use system normaliz
  rm "$SRCDIR"/pkg/normalizinterface/prerequisites.sh
# Use system nauty
  rm -r "$SRCDIR"/pkg/grape/{configure,Makefile*,nauty*}
# Fix https://bugs.archlinux.org/task/55174
  sed -e '/xgap/d' -i "$SRCDIR"/pkg/sonata/PackageInfo.g
  sed -e '/XGAP/d' -i "$SRCDIR"/pkg/cryst/PackageInfo.g


./configure --prefix=/usr --with-gmp=system
make

# Install libgap so we can link packages against it
mkdir -pv tmp-install
make DESTDIR="$SRCDIR"/tmp-install install-libgap

cd "$SRCDIR"/pkg
export LDFLAGS+=" -L$SRCDIR/tmp-install/usr/lib -lgap" # See https://trac.sagemath.org/ticket/27372
export LD_LIBRARY_PATH="$SRCDIR"/tmp-install/usr/lib
../bin/BuildPackages.sh --strict \
  --add-package-config-Semigroups --with-external-libsemigroups \
  --add-package-config-Digraphs "--with-external-planarity --with-external-bliss"

cd "$SRCDIR"

make DESTDIR="$PKGDIR" install

for _pkg in ${_standardpkgs[@]}; do
    cp -rv pkg/$_pkg "$PKGDIR"/usr/share/gap/pkg
done

for _pkg in $(ls "$PKGDIR"/usr/share/gap/pkg); do
  _ver=$(jq .[\"${_pkg}\"].Version "$SRCDIR"/package-infos-4.13.0.json | sed -e 's/"//g')
  _prov="gap-$_pkg=${_ver/-/.}"
  provides+=($_prov)
done

mkdir -pv "$PKGDIR"/usr/{bin,lib/gap/pkg}
cp -rv grp "$PKGDIR"/usr/lib/gap
chmod 755 "$PKGDIR"/usr/lib/gap/pkg

# fix xgap launch script
  sed -e "s|/build/gap/src/gap-$pkgver|/usr/lib/gap|g" -e 's|^GAP=.*|GAP=/usr/lib/gap/gap|g' \
    "$PKGDIR"/usr/lib/gap/pkg/xgap/xgap.sh > "$PKGDIR"/usr/bin/xgap
  chmod 755 "$PKGDIR"/usr/bin/xgap
  rm "$PKGDIR"/usr/lib/gap/pkg/xgap/xgap.sh

# provided by main gap package
  for _pkg in ${_standardpkgs[@]}; do
    rm -r "$PKGDIR"/usr/lib/gap/pkg/$_pkg
  done

# fix RPATH
find "$PKGDIR"/usr/lib/gap/pkg/ -name '*.so' | \
    xargs chrpath -d

# use system nauty in grape package
# ??? install -d "$PKGDIR"/usr/lib/gap/pkg/grape/bin/x86_64-pc-linux-gnu-default64-kv8
# ??? ln -s /usr/bin/dreadnaut "$PKGDIR"/usr/lib/gap/pkg/grape/bin/x86_64-pc-linux-gnu-default64-kv8

# remove leftover binaries and source files
find "$PKGDIR"/usr/lib/gap/pkg -name .libs -o -name '*.o' | \
    xargs rm -rfv
find "$PKGDIR"/usr/lib/gap/pkg -type d -name src | \
    xargs rm -rfv
#rm -rfv "$PKGDIR"/usr/lib/gap/pkg/log
rm -r "$pkgdir"/usr/lib/gap/pkg/digraphs/extern
rm -r "$pkgdir"/usr/lib/gap/pkg/semigroups/libsemigroups
rm -r "$pkgdir"/usr/lib/gap/pkg/caratinterface/carat*
rm -r "$pkgdir"/usr/lib/gap/pkg/kbmag/standalone
rm -r "$pkgdir"/usr/lib/gap/pkg/log
rm -r "$pkgdir"/usr/lib/gap/pkg/*/gen
