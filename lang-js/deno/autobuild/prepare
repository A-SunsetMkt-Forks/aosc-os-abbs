export V8_FROM_SOURCE=1
export CLANG_BASE_PATH='/usr/'
export GN_ARGS="no_inline_line_tables=false is_clang=false v8_enable_pointer_compression=true treat_warnings_as_errors=false \
                custom_toolchain=\"//build/toolchain/linux/unbundle:default\" host_toolchain=\"//build/toolchain/linux/unbundle:default\""
export GN="/usr/bin/gn"
export AR=ar
export NM=nm
export CFLAGS="$CFLAGS -fPIC"
export CXXFLAGS="$CXXFLAGS -fPIC"

# ld.gold is very likely to crash on amd64/aarch64/ppc64, and lld is unusable on loongson3
if ! ab_match_arch '(loongson3|loongarch64|mips64r6el)'; then
   export AR=llvm-ar
   export NM=llvm-nm
   export LDFLAGS="${LDFLAGS} -fuse-ld=lld"
   export RUSTFLAGS="${RUSTFLAGS} -Clink-arg=-fuse-ld=lld -Clink-arg=-Wl,-build-id=sha1 -Clinker=clang"
   export GN_ARGS="$GN_ARGS use_lld=true"
else
   export DISABLE_CLANG=1
   export RUSTFLAGS="${RUSTFLAGS} -Clinker=gcc -Clink-arg=-fuse-ld=bfd"
   export GN_ARGS="$GN_ARGS use_lld=false use_gold=false"
fi

if ! ab_match_arch "(amd64|arm64|ppc64el|loongarch64|loongson3|riscv64)"; then
   export GN_ARGS="$GN_ARGS v8_enable_pointer_compression_shared_cage=false"
fi
# workaround v8 issues
abinfo "Fetching dependency sources ..."
cargo update simd-json
cargo fetch --locked
PATCHES_DIR="$SRCDIR/autobuild/patches"
pushd /root/.cargo/registry/src/index.crates.io-*/v8-0.93.1/
ab_apply_patches "${PATCHES_DIR}"/*.deferred
popd
